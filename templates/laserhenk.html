<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>LASERHENK â€” Agentic AI Tailoring System</title>
  <meta name="description" content="LASERHENK orchestrates AI agents for tailored menswear consultation." />
  <style>
    :root{
      --bg: #0b0c0f;
      --panel: #121418;
      --muted: #8b90a1;
      --text: #eef1f6;
      --accent: #6ea8fe;
      --accent-strong: #4c8dff;
      --agent-bg: #1a1f2a;
      --border: #20232b;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
      --success: #10b981;
      --warning: #f59e0b;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 80% -200px, #182036 0%, var(--bg) 60%);
      color: var(--text);
      font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Inter, Ubuntu, Cantarell, sans-serif;
    }

    /* Top bar */
    .topbar{
      position: sticky; top:0; z-index:10;
      display:flex; align-items:center; justify-content:space-between;
      padding: 14px 18px;
      background: rgba(10,12,16,.6);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid var(--border);
    }
    .brand{ display:flex; align-items:center; gap:12px; }
    .logo{
      width:36px; height:36px; display:grid; place-items:center;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--accent-strong), #9ec5ff);
      color:#0b1a33; font-weight: 800; font-size: 18px;
      box-shadow: var(--shadow);
    }
    .titles h1{ font-size:18px; margin:0; letter-spacing:.2px; }
    .subtitle{ margin:0; color:var(--muted); font-size:12px; }
    .actions{ display:flex; gap:8px; }

    .btn{
      display:inline-flex; align-items:center; gap:.5rem;
      border:1px solid var(--border);
      background: var(--panel);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 12px;
      cursor:pointer;
      font-size: 14px;
      font-family: inherit;
      transition: transform .06s ease, border-color .2s ease, background .2s ease;
    }
    .btn:hover:not(:disabled){ transform: translateY(-1px); }
    .btn:active:not(:disabled){ transform: translateY(0); }
    .btn:disabled{
      opacity: 0.4;
      cursor: not-allowed;
    }
    .btn.primary{
      background: linear-gradient(180deg, var(--accent), var(--accent-strong));
      color: #071326;
      border-color: transparent;
      font-weight: 600;
    }
    .btn.success{
      background: linear-gradient(180deg, var(--success), #059669);
      color: white;
      border-color: transparent;
      font-weight: 600;
    }

    /* Layout */
    .container{
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }

    .card{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 18px;
      box-shadow: var(--shadow);
    }
    .card h2{
      margin: 0 0 16px 0;
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
    }

    /* Session info */
    .session-info{
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px;
      background: rgba(110,168,254,0.1);
      border: 1px solid rgba(110,168,254,0.2);
      border-radius: 10px;
      margin-bottom: 14px;
    }
    .status{
      display: inline-block;
      padding: 4px 10px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    .status.idle{
      background: rgba(139,144,161,0.2);
      color: var(--muted);
    }
    .status.active{
      background: rgba(16,185,129,0.2);
      color: var(--success);
    }

    /* Controls */
    .controls{
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    /* Agents grid */
    .agents-grid{
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 14px;
    }
    .agent-card{
      padding: 16px;
      background: var(--agent-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      transition: all 0.2s ease;
    }
    .agent-card:hover{
      border-color: var(--accent);
      transform: translateY(-2px);
    }
    .agent-card.active{
      border-color: var(--accent-strong);
      background: linear-gradient(180deg, #1e2a3a, #1a1f2a);
      box-shadow: 0 0 0 2px rgba(110,168,254,0.3);
    }
    .agent-card h3{
      color: var(--accent);
      margin: 0 0 8px 0;
      font-size: 16px;
      font-weight: 600;
    }
    .agent-card p{
      font-size: 14px;
      color: var(--muted);
      margin: 0 0 6px 0;
    }
    .agent-card small{
      font-size: 12px;
      color: var(--muted);
      opacity: 0.7;
    }

    /* Messages */
    .messages{
      max-height: 500px;
      overflow-y: auto;
      padding: 14px;
      background: rgba(10,12,16,0.4);
      border-radius: 12px;
      border: 1px solid var(--border);
    }
    .messages::-webkit-scrollbar{
      width: 8px;
    }
    .messages::-webkit-scrollbar-track{
      background: transparent;
    }
    .messages::-webkit-scrollbar-thumb{
      background: var(--border);
      border-radius: 4px;
    }
    .message{
      padding: 12px 14px;
      margin-bottom: 10px;
      border-radius: 10px;
      background: linear-gradient(180deg, var(--agent-bg), #121620);
      border: 1px solid var(--border);
    }
    .message strong{
      color: var(--accent);
      display: block;
      margin-bottom: 4px;
      font-size: 13px;
      font-weight: 600;
    }
    .message-placeholder{
      color: var(--muted);
      font-size: 14px;
      text-align: center;
      padding: 20px;
    }

    /* Responsive */
    @media (max-width: 560px){
      .controls{
        flex-direction: column;
      }
      .btn{
        width: 100%;
        justify-content: center;
      }
      .agents-grid{
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="topbar" role="banner">
    <div class="brand">
      <span class="logo" aria-hidden="true">L</span>
      <div class="titles">
        <h1>LASERHENK</h1>
        <p class="subtitle">Agentic AI Tailoring System</p>
      </div>
    </div>
    <nav aria-label="Quick actions" class="actions">
      <button id="clearBtn" class="btn" title="Restart">
        Restart
      </button>
    </nav>
  </header>

  <!-- Main Content -->
  <main class="container" role="main">
    <!-- Session Control -->
    <section class="card">
      <h2>Session Control</h2>
      <div class="session-info">
        <span id="session-status" class="status idle">No Session</span>
        <span id="session-id" style="color: var(--muted); font-size: 14px;"></span>
      </div>
      <div class="controls">
        <button id="btn-new-session" class="btn primary">New Session</button>
        <button id="btn-start-workflow" class="btn success" disabled>Start Workflow</button>
        <button id="btn-resume-workflow" class="btn success" disabled>Resume</button>
      </div>
    </section>

    <!-- Agents -->
    <section class="card">
      <h2>Agent Network</h2>
      <div id="agents-grid" class="agents-grid">
        <!-- Agents will be loaded here -->
      </div>
    </section>

    <!-- Messages -->
    <section class="card">
      <h2>Workflow Messages</h2>
      <div id="messages" class="messages">
        <p class="message-placeholder">No messages yet. Start a session to begin.</p>
      </div>
    </section>
  </main>

  <!-- JavaScript -->
  <script>
    const CONFIG = {
      BACKEND_URL: '/LASERHENK'
    };

    const els = {
      sessionStatus: document.getElementById('session-status'),
      sessionId: document.getElementById('session-id'),
      btnNewSession: document.getElementById('btn-new-session'),
      btnStartWorkflow: document.getElementById('btn-start-workflow'),
      btnResumeWorkflow: document.getElementById('btn-resume-workflow'),
      clearBtn: document.getElementById('clearBtn'),
      agentsGrid: document.getElementById('agents-grid'),
      messages: document.getElementById('messages')
    };

    let currentSession = {
      id: null,
      active: false
    };

    // UI helpers
    function scrollMessages(){
      requestAnimationFrame(() => {
        els.messages.scrollTop = els.messages.scrollHeight;
      });
    }

    function addMessage(role, content){
      // Remove placeholder if exists
      const placeholder = els.messages.querySelector('.message-placeholder');
      if (placeholder) {
        placeholder.remove();
      }

      const msg = document.createElement('div');
      msg.className = 'message';
      msg.innerHTML = `<strong>${sanitize(role)}</strong>${sanitize(content)}`;
      els.messages.appendChild(msg);
      scrollMessages();
    }

    function sanitize(str){
      return String(str).replace(/[&<>"]/g, c => ({
        "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;"
      }[c]));
    }

    function setBusy(isBusy){
      els.btnNewSession.disabled = isBusy;
      els.btnStartWorkflow.disabled = isBusy || !currentSession.active;
      els.btnResumeWorkflow.disabled = isBusy;
    }

    function updateSessionUI(sessionId){
      currentSession.id = sessionId;
      currentSession.active = true;
      els.sessionStatus.textContent = 'Active';
      els.sessionStatus.className = 'status active';
      els.sessionId.textContent = `ID: ${sessionId.substring(0, 8)}...`;
      els.btnStartWorkflow.disabled = false;
    }

    function clearSession(){
      currentSession = { id: null, active: false };
      els.sessionStatus.textContent = 'No Session';
      els.sessionStatus.className = 'status idle';
      els.sessionId.textContent = '';
      els.btnStartWorkflow.disabled = true;
      els.btnResumeWorkflow.disabled = true;
      els.messages.innerHTML = '<p class="message-placeholder">No messages yet. Start a session to begin.</p>';
    }

    // Load agents
    async function loadAgents(){
      try {
        const response = await fetch(`${CONFIG.BACKEND_URL}/agents`);
        const data = await response.json();

        els.agentsGrid.innerHTML = '';

        data.agents.forEach(agent => {
          const card = document.createElement('div');
          card.className = 'agent-card';
          card.id = `agent-${agent.name.toLowerCase().replace(/\s+/g, '-')}`;
          card.innerHTML = `
            <h3>${sanitize(agent.name)}</h3>
            <p>${sanitize(agent.description)}</p>
            <small>${sanitize(agent.phase)}</small>
          `;
          els.agentsGrid.appendChild(card);
        });
      } catch (error) {
        console.error('Failed to load agents:', error);
        addMessage('Error', `Failed to load agents: ${error.message}`);
      }
    }

    // Create new session
    async function createNewSession(){
      try {
        setBusy(true);
        const response = await fetch(`${CONFIG.BACKEND_URL}/session/new`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });

        const data = await response.json();

        if (data.success) {
          updateSessionUI(data.session_id);
          addMessage('System', data.message || 'Session created successfully');
        } else {
          throw new Error(data.error || 'Failed to create session');
        }
      } catch (error) {
        console.error('Error:', error);
        addMessage('Error', error.message);
      } finally {
        setBusy(false);
      }
    }

    // Start workflow
    async function startWorkflow(){
      if (!currentSession.active) {
        addMessage('Error', 'No active session');
        return;
      }

      try {
        setBusy(true);
        addMessage('System', 'Starting workflow...');

        const response = await fetch(`${CONFIG.BACKEND_URL}/workflow/start`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();

        if (data.success) {
          if (data.messages && data.messages.length > 0) {
            data.messages.forEach(msg => {
              const role = msg.role || 'System';
              addMessage(role.charAt(0).toUpperCase() + role.slice(1), msg.content);
            });
          }
          addMessage('System', `Workflow completed. Current agent: ${data.current_agent || 'None'}`);
        } else {
          throw new Error(data.error || 'Workflow failed');
        }
      } catch (error) {
        console.error('Error:', error);
        addMessage('Error', error.message);
      } finally {
        setBusy(false);
      }
    }

    // Resume workflow
    async function resumeWorkflow(){
      if (!currentSession.active) {
        addMessage('Error', 'No active session');
        return;
      }

      try {
        setBusy(true);
        addMessage('System', 'Resuming workflow...');

        const response = await fetch(`${CONFIG.BACKEND_URL}/workflow/resume`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_input: null })
        });

        const data = await response.json();

        if (data.success) {
          if (data.messages && data.messages.length > 0) {
            data.messages.forEach(msg => {
              const role = msg.role || 'System';
              addMessage(role.charAt(0).toUpperCase() + role.slice(1), msg.content);
            });
          }
          addMessage('System', 'Workflow resumed');
        } else {
          throw new Error(data.error || 'Resume failed');
        }
      } catch (error) {
        console.error('Error:', error);
        addMessage('Error', error.message);
      } finally {
        setBusy(false);
      }
    }

    // Event listeners
    els.btnNewSession.addEventListener('click', createNewSession);
    els.btnStartWorkflow.addEventListener('click', startWorkflow);
    els.btnResumeWorkflow.addEventListener('click', resumeWorkflow);
    els.clearBtn.addEventListener('click', () => {
      if (confirm('Clear session and restart?')) {
        clearSession();
      }
    });

    // Initialize
    loadAgents();
  </script>
</body>
</html>
