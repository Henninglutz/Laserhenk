<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>LASERHENK — Agentic AI Tailoring System</title>
  <meta name="description" content="LASERHENK orchestrates AI agents for tailored menswear consultation." />
  <style>
    :root{
      --bg: #0b0c0f;
      --panel: #121418;
      --muted: #8b90a1;
      --text: #eef1f6;
      --accent: #6ea8fe;
      --accent-strong: #4c8dff;
      --assistant: #1a1f2a;
      --user: #1e2a22;
      --border: #20232b;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 80% -200px, #182036 0%, var(--bg) 60%);
      color: var(--text);
      font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Inter, Ubuntu, Cantarell, sans-serif;
    }

    .sr-only{
      position:absolute; width:1px; height:1px; padding:0; margin:-1px;
      overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
    }

    /* Top bar */
    .topbar{
      position: sticky; top:0; z-index:10;
      display:flex; align-items:center; justify-content:space-between;
      padding: 14px 18px;
      background: rgba(10,12,16,.6);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid var(--border);
    }
    .brand{ display:flex; align-items:center; gap:12px; }
    .logo{
      width:36px; height:36px; display:grid; place-items:center;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--accent-strong), #9ec5ff);
      color:#0b1a33; font-weight: 800;
      box-shadow: var(--shadow);
    }
    .titles h1{ font-size:18px; margin:0; letter-spacing:.2px; }
    .subtitle{ margin:0; color:var(--muted); font-size:12px; }
    .actions{ display:flex; gap:8px; }

    .btn{
      display:inline-flex; align-items:center; gap:.5rem;
      border:1px solid var(--border);
      background: var(--panel);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 12px;
      cursor:pointer;
      font-size: 14px;
      font-family: inherit;
      transition: transform .06s ease, border-color .2s ease, background .2s ease;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn:active{ transform: translateY(0); }
    .btn.icon{ padding:10px; }
    .btn.ghost{ background: transparent; }
    .btn.link{ text-decoration: none; }
    .btn.primary{
      background: linear-gradient(180deg, var(--accent), var(--accent-strong));
      color: #071326;
      border-color: transparent;
      font-weight: 600;
    }

    /* Layout */
    .container{
      max-width: 920px;
      margin: 0 auto;
      padding: 16px;
    }
    .chat{
      display:flex; flex-direction:column; gap:14px;
      padding: 10px;
      min-height: calc(100dvh - 220px);
    }
    .msg{ display:flex; }
    .msg.assistant{ justify-content:flex-start; }
    .msg.user{ justify-content:flex-end; }
    .bubble{
      max-width: 72ch;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }
    .msg.assistant .bubble{
      background: linear-gradient(180deg, var(--assistant), #121620);
    }
    .msg.user .bubble{
      background: linear-gradient(180deg, var(--user), #142018);
    }

    /* Composer */
    .composer{
      position: sticky; bottom: 0;
      display:flex; gap: 10px; align-items:center;
      padding: 12px;
      background: rgba(12,14,18,.6);
      backdrop-filter: blur(8px);
      border-top: 1px solid var(--border);
      border-radius: 14px;
      margin-top: 14px;
    }
    .input{
      flex:1;
      background: var(--panel);
      color: var(--text);
      border:1px solid var(--border);
      padding: 12px 12px;
      border-radius: 12px;
      font-size: 16px;
      font-family: inherit;
    }
    .input::placeholder{ color: var(--muted); }
    .input:focus{
      outline: none;
      border-color: var(--accent);
    }

    .send-text{ margin-left: 4px; }

    /* Footnote */
    .footnote{
      color: var(--muted);
      margin-top: 12px;
      font-size: 13px;
    }
    .footnote summary{
      cursor: pointer;
      padding: 8px 0;
    }

    /* Small screens */
    @media (max-width: 560px){
      .send-text{ display:none; }
    }
  </style>
</head>
<body>
  <header class="topbar" role="banner">
    <div class="brand">
      <span class="logo" aria-hidden="true">L</span>
      <div class="titles">
        <h1>LASERHENK</h1>
        <p class="subtitle">Agentic AI Tailoring System</p>
      </div>
    </div>
    <nav aria-label="Quick actions" class="actions">
      <button id="clearBtn" class="btn ghost" title="Clear chat">
        Clear
      </button>
    </nav>
  </header>

  <main id="main" class="container" role="main">
    <section id="chat" class="chat" aria-live="polite" aria-busy="false">
      <!-- Messages render here -->
      <div class="msg assistant">
        <div class="bubble">
          Hallo! Ich bin <strong>LASERHENK</strong>, dein AI-gestütztes Agenten-System für maßgeschneiderte Herrenmode.<br/><br/>
          Ich orchestriere verschiedene KI-Agenten, um dir bei deinem perfekten Outfit zu helfen:<br/>
          • <strong>HENK1</strong> ermittelt deine Bedürfnisse<br/>
          • <strong>Design HENK</strong> erstellt dein Wunsch-Outfit<br/>
          • <strong>LASERHENK</strong> nimmt präzise Maße<br/><br/>
          Erzähl mir von deinem Anlass – wir starten den Workflow!
        </div>
      </div>
    </section>

    <form id="composer" class="composer" autocomplete="off" aria-label="Message composer">
      <label for="message" class="sr-only">Your message</label>
      <input
        id="message"
        name="message"
        class="input"
        type="text"
        placeholder="Beschreibe deinen Anlass, Stil-Wünsche..."
        maxlength="2000"
        required
      />

      <button id="sendBtn" type="submit" class="btn primary" title="Send">
        <svg width="18" height="18" viewBox="0 0 24 24" focusable="false" aria-hidden="true">
          <path fill="currentColor" d="M2 21l21-9L2 3v7l15 2-15 2v7z"/>
        </svg>
        <span class="send-text">Send</span>
      </button>
    </form>

    <details class="footnote">
      <summary>Workflow Status</summary>
      <div>
        Session: <code id="sessionIdLabel">none</code><br/>
        Current Agent: <code id="currentAgentLabel">none</code>
      </div>
    </details>
  </main>

  <script>
    const CONFIG = {
      BACKEND_URL: '/LASERHENK',
      MAX_HISTORY: 20
    };

    const els = {
      chat: document.getElementById('chat'),
      form: document.getElementById('composer'),
      input: document.getElementById('message'),
      send: document.getElementById('sendBtn'),
      clear: document.getElementById('clearBtn'),
      sessionIdLabel: document.getElementById('sessionIdLabel'),
      currentAgentLabel: document.getElementById('currentAgentLabel')
    };

    let history = []; // {role:"user"|"assistant", content:string}
    let sessionId = null;
    let currentAgent = null;

    // UI helpers
    function scrollToBottom(){
      requestAnimationFrame(() => {
        els.chat.scrollTop = els.chat.scrollHeight;
      });
    }

    function el(tag, className, text){
      const n = document.createElement(tag);
      if (className) n.className = className;
      if (text) n.textContent = text;
      return n;
    }

    function addMessage(role, content){
      const wrap = el('div', `msg ${role}`);
      const bubble = el('div', 'bubble');
      bubble.innerHTML = sanitize(content).replace(/\n/g, '<br/>');
      wrap.appendChild(bubble);
      els.chat.appendChild(wrap);
      scrollToBottom();
    }

    function sanitize(str){
      return str.replace(/[&<>"]/g, c => ({
        '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;'
      }[c]));
    }

    function setBusy(isBusy){
      els.chat.setAttribute('aria-busy', isBusy ? 'true' : 'false');
      els.send.disabled = !!isBusy;
      els.input.disabled = !!isBusy;
    }

    function updateStatus(){
      els.sessionIdLabel.textContent = sessionId ? sessionId.substring(0, 8) + '...' : 'none';
      els.currentAgentLabel.textContent = currentAgent || 'none';
    }

    // Networking
    async function ensureSession(){
      if (sessionId) return sessionId;

      try {
        const response = await fetch(`${CONFIG.BACKEND_URL}/session/new`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });

        const data = await response.json();

        if (data.success) {
          sessionId = data.session_id;
          updateStatus();
          return sessionId;
        } else {
          throw new Error(data.error || 'Failed to create session');
        }
      } catch (err) {
        console.error('Session creation failed:', err);
        addMessage('assistant', `Sorry, konnte keine Session erstellen. (${err.message})`);
        return null;
      }
    }

    async function sendMessage(userText){
      const sid = await ensureSession();
      if (!sid) return;

      try{
        setBusy(true);

        const response = await fetch(`${CONFIG.BACKEND_URL}/workflow/start`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if(!response.ok){
          throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();

        if (data.success) {
          if (data.messages && data.messages.length > 0) {
            data.messages.forEach(msg => {
              const role = msg.role === 'user' ? 'user' : 'assistant';
              history.push({ role, content: msg.content });
              addMessage(role, msg.content);
            });
          }

          if (data.current_agent) {
            currentAgent = data.current_agent;
            updateStatus();
          }

          const replyText = `Workflow abgeschlossen. Aktueller Agent: ${data.current_agent || 'none'}`;
          history.push({ role: 'assistant', content: replyText });
          addMessage('assistant', replyText);
        } else {
          throw new Error(data.error || 'Workflow failed');
        }
      }catch(err){
        console.error(err);
        addMessage('assistant', `Sorry, ein Fehler ist aufgetreten. (${err.message})`);
      }finally{
        setBusy(false);
      }
    }

    // Events
    els.form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = els.input.value.trim();
      if(!text) return;
      els.input.value = '';
      history.push({ role: 'user', content: text });
      addMessage('user', text);
      await sendMessage(text);
    });

    els.input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        els.form.requestSubmit();
      }
    });

    els.clear.addEventListener('click', () => {
      if (!confirm('Chat löschen und neu starten?')) return;
      history = [];
      sessionId = null;
      currentAgent = null;
      els.chat.innerHTML = '';
      updateStatus();
      addMessage('assistant',
        'Hallo! Ich bin <strong>LASERHENK</strong>, dein AI-gestütztes Agenten-System für maßgeschneiderte Herrenmode.<br/><br/>' +
        'Ich orchestriere verschiedene KI-Agenten, um dir bei deinem perfekten Outfit zu helfen:<br/>' +
        '• <strong>HENK1</strong> ermittelt deine Bedürfnisse<br/>' +
        '• <strong>Design HENK</strong> erstellt dein Wunsch-Outfit<br/>' +
        '• <strong>LASERHENK</strong> nimmt präzise Maße<br/><br/>' +
        'Erzähl mir von deinem Anlass – wir starten den Workflow!'
      );
    });

    // Initialize
    updateStatus();
  </script>
</body>
</html>
